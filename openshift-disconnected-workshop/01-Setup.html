<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Setup :: OCP Disconnected Workshop</title>
    <link rel="canonical" href="https://manuvaldi.github.io/openshift-disconnected-workshop/openshift-disconnected-workshop/01-Setup.html">
    <link rel="prev" href="index.html">
    <link rel="next" href="02-Deploy-Cluster.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://manuvaldi.github.io/openshift-disconnected-workshop">OCP Disconnected Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="openshift-disconnected-workshop" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-Setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#prerequisite">Prerequisites</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#prerequisite-binaries">kcli and binaries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#presequisites-sshuttle">sshuttle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#registryvm">Registry VM</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#registryvm-registryv2">Create registry with registry:v2 image (classic)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#registryvm-mirror-registry">Create registry with mirror-registry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#registryvm-quay-standalone">Create Registry Quay standalone with proxy cache/mirror functionality</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#registryvm-cachecontainer">Creating Registry Cache with registry-cache container</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#testing-registries">Testing registries</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-Deploy-Cluster.html">Cluster Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-Mirror-OCP-Images.html">Mirroring Openshift Images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-Mirror-OCP-Images.html#mirroroc">Mirror with oc binary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-Mirror-OCP-Images.html#mirrorocmirror">Mirror with oc-mirror binary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html">Convert Cluster to disconnected</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html#importca">Import CA certificates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html#configuremirrors">Configure mirrors in the cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html#updatepullsecret">Update global pull secret</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html#isolatecluster">Isolate the cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-Convert-Cluster-Disconnected.html#reboot">Reboot node and check registry logs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-Disconnected-Upgrades.html">Disconnected Upgrades</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-Disconnected-Upgrades.html#upgrade1">Upgrade to 4.9.22 with a registry mirror-registry in registry.dsal (8443)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-Disconnected-Upgrades.html#upgrade2">Upgrade to 4.10.20 with a basic/mini Quay in registry.dsal (443)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-Disconnected-Upgrades.html#upgrade3">Upgrade to 4.11.20 with a registry cache in registry.dsal (6443)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-Disconnected-Deployment.html">Disconnected Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-Disconnected-Operators.html">Disconnected Catalogs and Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-Disconnected-Operators.html#catalogs">Disconnected Catalogs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07-Disconnected-Operators.html#defaultmirrored">Default catalogs with images mirrored and <code>ImageContentSourcePolicy</code></a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07-Disconnected-Operators.html#defaultmirrroredcustomcatalogs">Default catalogs with images mirrored and Custom catalogs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07-Disconnected-Operators.html#customcatalog">Custom catalog</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-Disconnected-Operators.html#operators">Disconnected Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="07-Disconnected-Operators.html#mirroringoc">Mirroring with <code>oc</code></a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-Disconnected-Operators.html#mirroringocmirror">Mirroring with <code>oc-mirror</code></a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07-Disconnected-Operators.html#imagesetcustomcatalog">ImageSet for custom catalog index</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="07-Disconnected-Operators.html#imagesetfiltered">ImageSet for official catalog filtered</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-Insights-and-Telemetry.html">Insights and Telemetry services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-Insights-and-Telemetry.html#insights">Insights</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-Insights-and-Telemetry.html#disableinsights">Disable Insights</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-Insights-and-Telemetry.html#insightsmanualupload">Manual upload</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-Insights-and-Telemetry.html#telemetry">Telemetry client</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-Insights-and-Telemetry.html#telemetrymanualupload">Manual Upload</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-Cluster-Samples.html">Cluster Samples Operator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-Openshift-Update-Service.html">Openshift Update Service</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-Proxy.html">Cluster-wide Proxy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="99-References.html">References</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OCP Disconnected Workshop</a></li>
    <li><a href="01-Setup.html">Setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/manuvaldi/openshift-disconnected-workshop/edit/master/documentation/modules/ROOT/pages/01-Setup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Setup</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>All our environment would be on a hypervisor. In this machine we will run:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A registry VM, where we will run different registry container solutions.</p>
</li>
<li>
<p>A connected Openshift Deployment which later will become disconnected.</p>
</li>
<li>
<p>A disconnected Openshift Deployment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Openshift clusters will be SNO (Single-Node Openshift) deployments, so they will have only one VM. (master+worker).</p>
</li>
<li>
<p>We will use <code>kcli</code> tool (<a href="https://kcli.readthedocs.io/en/latest/" class="bare">https://kcli.readthedocs.io/en/latest/</a>) to deploy the registry VM and the Openshift Clusters</p>
</li>
<li>
<p>Apart from the deployment of different registry solutions, most of the operations and commands will be executed directly from the hypervisor shell.</p>
</li>
<li>
<p>To simplify we will use always root user.</p>
</li>
<li>
<p>If we need a web browser, we will use <code>sshuttle</code> tool (<a href="https://sshuttle.readthedocs.io/en/stable/" class="bare">https://sshuttle.readthedocs.io/en/stable/</a>) to create a kind of "VPN" via SSH between our laptop/PC and the libvirtd network running on our Hypervisor</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/environment.png" alt="Lab Environment" width="800">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisite"><a class="anchor" href="#prerequisite"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="prerequisite-binaries"><a class="anchor" href="#prerequisite-binaries"></a>kcli and binaries</h3>
<div class="paragraph">
<p>Connect via ssh to the <strong>hypervisor</strong> and become root with <code>sudo su</code>. The rest of the workshop we will use <code>root</code> as default user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install libvirtd and basic binaries</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">yum -y install libvirt libvirt-daemon-driver-qemu qemu-kvm dnf nano jq vim wget podman skopeo
usermod -aG qemu,libvirt $(id -un)
newgrp libvirt
systemctl enable --now libvirtd</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Install <code>kcli</code></p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl <a href="https://raw.githubusercontent.com/karmab/kcli/main/install.sh" class="bare">https://raw.githubusercontent.com/karmab/kcli/main/install.sh</a> | sudo bash</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a pool with the additional disk mounted in <code>/mnt</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Probably you may format and mount extra disk to <code>/mnt</code> path. Example:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkfs.xfs -f /dev/sdb1 &amp;&amp; mount /dev/sdb1 /mnt</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kcli create pool -p /mnt default</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Since all VMs will be stored in the "pool," adequate space must be allocated for them. Therefore, if the current directory assigned for storage (/mnt) has less than 370GB of space available, it should be changed to a directory with sufficient space.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Install some binaries (oc, kubectl and opm):</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget <a href="https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.20/openshift-client-linux.tar.gz" class="bare">https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.20/openshift-client-linux.tar.gz</a>
tar xvfz openshift-client-linux.tar.gz
mv oc /usr/local/bin/
mv kubectl /usr/local/bin/
rm -f openshift-client-linux.tar.gz

wget <a href="https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.20/opm-linux-4.11.20.tar.gz" class="bare">https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.20/opm-linux-4.11.20.tar.gz</a>
tar xvfz opm-linux-4.11.20.tar.gz
cp opm /usr/local/bin/
chmod +x /usr/local/bin/opm</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="presequisites-sshuttle"><a class="anchor" href="#presequisites-sshuttle"></a>sshuttle</h3>
<div class="paragraph">
<p>To be able to access to VM network from our laptop/PC we will use <code>sshuttle</code>. This software allow traffic through ssh protocol, similar to a VPN.</p>
</div>
<div class="paragraph">
<p>If you use Fedora/RHEL/CentOS:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dnf install -y sshuttle</code></pre>
</div>
</div>
<div class="paragraph">
<p>To open a "<strong>VPN</strong>" execute from your laptop/PC:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sshuttle -r root@&lt;public ip of your hypervisor&gt; 192.168.122.0/24</code></pre>
</div>
</div>
<div class="paragraph">
<p>or if you connect using certificates:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sshuttle -r root@&lt;public ip of your hypervisor&gt; 192.168.122.0/24  --ssh-cmd 'ssh -i &lt;your certificate&gt;.pem'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will route the traffic from <strong>YOUR LAPTOP/PC</strong> to the network <code>192.168.122.0/24</code> (libvirtd network in our hypervisor) via ssh connection.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registryvm"><a class="anchor" href="#registryvm"></a>Registry Virtual Machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we have our machine prepared to create VMs with libvirtd. Connect to your hypervisor and become root.</p>
</div>
<div class="paragraph">
<p>The first VM will be our <code>registry</code> machine. In this VM we will test 4 different solutions to host or cache Openshift images:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Docker Registry v2 with the container image <code>registry:v2</code></p>
</li>
<li>
<p>Registry with <code>mirror-registry</code>: a software provided by Red Hat based on Quay</p>
</li>
<li>
<p>Basic installation of Quay: a minimal non-prod installation of Quay, to be able to enable and configure the mirror function in an org.</p>
</li>
<li>
<p>Registry cache. An open source software created by @manuvaldi (<a href="https://github.com/manuvaldi/registry-cache" class="bare">https://github.com/manuvaldi/registry-cache</a>) that allows caching of images from different repositories in a simple way.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Follow next steps to create a VM containing all registries servers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Before create any VM we will generate a key pair for ssh</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-keygen -t rsa</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Download Fedora image with <code>kcli</code></p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kcli download image fedoralatest</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create registry vm</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kcli create vm -i fedoralatest -P disks=[250] -P memory=8192 -P numcpus=4  registry</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Get IP from registry VM and add the dns to /etc/hosts</p>
</li>
</ul>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ kcli list vm
---------------------------------------------------------------------------------------------+
|   Name   | Status |       Ip      |                 Source                |  Plan |   Profile    |
---------------------------------------------------------------------------------------------+
| registry |   up   | 192.168.122.X | Fedora-Cloud-Base-37-1.7.x86_64.qcow2 | kvirt | fedoralatest |
---------------------------------------------------------------------------------------------+</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create <code>/etc/hosts</code> entry:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "192.168.122.X registry.dsal" &gt;&gt; /etc/hosts</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>To refer to this VM we will use always the DNS <code>registry.dsal</code></p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>Now reload libvirtd to load dns changes</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl reload libvirtd</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will connect to the registry VM and we will start to install the different containers registry solutions:</p>
</div>
<div class="sect2">
<h3 id="registryvm-registryv2"><a class="anchor" href="#registryvm-registryv2"></a>Create registry with registry:v2 image (classic)</h3>
<div class="paragraph">
<p>Connect to registry instance with <code>kcli ssh registry</code> and then (uso <code>sudo su</code> again):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>connect to VM:</p>
</li>
</ul>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ kcli ssh registry

[fedora@registry ~]$ sudo su
[root@registry fedora]#</code></pre>
</div>
</div>
<div class="paragraph">
<p>and now from the prompt of the registry VM do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set permissive o disable selinux</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config
setenforce 0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>We can use the guide in the blog post <a href="https://www.redhat.com/en/blog/openshift-private-registry" class="bare">https://www.redhat.com/en/blog/openshift-private-registry</a> to create a registry. In the following lines the "summary" :)</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">REGISTRYHOSTNAME=registry.dsal

# dnf update -q -y

mkdir -p /data/registry/{auth,certs,data}

openssl req -newkey rsa:4096 -nodes -sha256 \
-keyout /data/registry/certs/registry.key -x509 -days 3650 \
-out /data/registry/certs/registry.crt \
-subj "/CN=$REGISTRYHOSTNAME" \
-addext "subjectAltName = DNS:$REGISTRYHOSTNAME"

cat /data/registry/certs/registry.crt /data/registry/certs/registry.key  &gt; /data/registry/certs/certs.pem

cp /data/registry/certs/registry.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust

dnf -y install httpd-tools
htpasswd -bBc /data/registry/auth/htpasswd registry redhat12345678

dnf -y install podman acl
podman create --name ocp-registry --net host -p 5000:5000 \
  -v /data/registry/data:/var/lib/registry:z -v /data/registry/auth:/auth:z \
  -e "REGISTRY_AUTH=htpasswd" -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry" \
  -e "REGISTRY_HTTP_SECRET=$(date | md5sum)" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd -v /data/registry/certs:/certs:z \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/registry.key docker.io/library/registry:2

podman start ocp-registry

cat &lt;&lt;EOF &gt; ~/registry-secret.json
"$REGISTRYHOSTNAME:5000": {   "email": "<a href="mailto:registry@redhat.com">registry@redhat.com</a>",   "auth": "$(echo -n 'registry:redhat12345678' | base64 -w0)"}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>After this step we have:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Our Fedora VM updated</p>
</li>
<li>
<p>Certificates for <code>registry.dsal</code> host, which we will use for all our registry servers, in the path <code>/data/registry/certs/</code>.</p>
</li>
<li>
<p>A <code>registry:v2</code> container.</p>
</li>
<li>
<p>A htpasswd file with the credentials</p>
</li>
<li>
<p>A json file with the credentials to accesss to this registry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can see our containter running:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[root@registry fedora]# podman ps
CONTAINER ID  IMAGE                         COMMAND               CREATED         STATUS         PORTS       NAMES
60fe656511eb  docker.io/library/registry:2  /etc/docker/regis...  15 seconds ago  Up 15 seconds              ocp-registry</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="registryvm-mirror-registry"><a class="anchor" href="#registryvm-mirror-registry"></a>Create registry with mirror-registry</h3>
<div class="paragraph">
<p>From the registry VM do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install dependencies and download binary</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf -y -q install podman acl wget
mkdir -p ~/mirror-registry &amp;&amp; cd ~/mirror-registry
wget <a href="https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.3.2/mirror-registry.tar.gz" class="bare">https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.3.2/mirror-registry.tar.gz</a>
tar xvfz mirror-registry.tar.gz</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the mirror-registry executing the next command:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mirror-registry install \
  --quayHostname registry.dsal \
  --quayRoot /data/mirror-registry \
  --initUser registry \
  --initPassword redhat12345678 \
  --sslCert /data/registry/certs/registry.crt \
  --sslKey /data/registry/certs/registry.key</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we reused the certificates and the same user/password.</p>
</div>
<div class="paragraph">
<p>After some time, A a mirror-registry registry will be running with the url:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">....
INFO[2023-03-14 15:02:25] Quay installed successfully, permanent data is stored in /data/mirror-registry
INFO[2023-03-14 15:02:25] Quay is available at <a href="https://registry.dsal:8443" class="bare">https://registry.dsal:8443</a> with credentials (registry, redhat12345678)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="registryvm-quay-standalone"><a class="anchor" href="#registryvm-quay-standalone"></a>Create Registry Quay standalone with proxy cache/mirror functionality</h3>
<div class="paragraph">
<p>First of all, open a browser in your laptop and go to <code><a href="https://console.redhat.com/openshift/downloads#tool-pull-secret" class="bare">https://console.redhat.com/openshift/downloads#tool-pull-secret</a></code> and copy a Openshift pull secret to <code>~/pull-secret.json</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Now, copy it to docker dir:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir -p /root/.docker &amp;&amp; cp ~/pull-secret.json ~/.docker/config.json</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Prepare and run postgresql and redis containers. Then, we will run a Quay Config container to be able to create a configuration for our "mini" Quay deployment.</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export QUAY=/data/quay
mkdir -p $QUAY/postgres-quay
setfacl -m u:26:-wx $QUAY/postgres-quay

podman run -d --name quay-standalone-postgresql \
  -e POSTGRESQL_USER=quayuser \
  -e POSTGRESQL_PASSWORD=quaypass \
  -e POSTGRESQL_DATABASE=quay \
  -e POSTGRESQL_ADMIN_PASSWORD=adminpass \
  -p 5432:5432 \
  -v $QUAY/postgres-quay:/var/lib/pgsql/data:Z \
  registry.redhat.io/rhel8/postgresql-10:1

sleep 10
podman exec -it quay-standalone-postgresql /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS pg_trgm" | psql -d quay -U postgres'

podman run -d  --name quay-standalone-redis \
  -p 6379:6379 \
  -e REDIS_PASSWORD=strongpassword \
  registry.redhat.io/rhel8/redis-5:1

podman run --rm -it --name quay_config -p 80:8080 -p 443:8443 registry.redhat.io/quay/quay-rhel8:v3.8.0 config secret</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The last command run the quay config container and leave it in foreground. We can access to the web ui from our laptop browser. It is possible because you are running <code>sshuttle</code> VPN.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
take note of passwords (<code>secret</code>) used for the next step ;)
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Now we are going to create a config file for quay. Open in your browser the config app in <a href="http://registry.dsal" class="bare">http://registry.dsal</a> (you can do it using the registry VM IP address instead)</p>
</li>
<li>
<p>login to UI with credentials: <code>quayconfig/secret</code></p>
</li>
<li>
<p>In Server Hostname: <code>registry.dsal</code></p>
</li>
<li>
<p>Use IP of <code>registry</code> machine for postgres and redis connection</p>
<div class="ulist">
<ul>
<li>
<p>PostgreSQL config:</p>
<div class="imageblock">
<div class="content">
<img src="_images/postgresql-config.png" alt="Postgres Config" width="800">
</div>
</div>
</li>
<li>
<p>Redis config:</p>
<div class="imageblock">
<div class="content">
<img src="_images/redis-config.png" alt="Redis Config" width="800">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>All passwords and port are in the script. look before asking!!!</p>
</li>
<li>
<p>In super-users section add 'registry' user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, validate config pushing the ending button and download de config. After that, you can stop config container with Control+C.</p>
</div>
<div class="paragraph">
<p>We need to leave the config in the registry VM, so we will copy de config bundle to hypervisor, and from the hypervisor to registry VM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download quay config and copy it to registry machine. From your laptop/PC run:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">scp quay-config.tar.gz root@&lt;fqdn/ip of your hypervisor&gt;:</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>and then copy from hypervisor to the registry VM:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kcli scp /root/quay-config.tar.gz registry:/tmp/</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Now, already in the Registry VM, prepare config and storage data dirs</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export QUAY=/data/quay
rm -Rf $QUAY/config &amp;&amp; mkdir $QUAY/config
cp /tmp/quay-config.tar.gz $QUAY/config
cd $QUAY/config
tar xvf quay-config.tar.gz
echo "FEATURE_PROXY_CACHE: true" &gt;&gt; /data/quay/config/config.yaml
sed 's/PREFERRED_URL_SCHEME:.*/PREFERRED_URL_SCHEME: https/' -i /data/quay/config/config.yaml
cp /data/registry/certs/registry.crt $QUAY/config/ssl.cert
cp /data/registry/certs/registry.key $QUAY/config/ssl.key
chmod 444 $QUAY/config/ssl*
mkdir -p $QUAY/storage
setfacl -m u:1001:-wx $QUAY/storage</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally run quay app container:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export QUAY=/data/quay
podman run -d  -p 80:8080 -p 443:8443  \
   --name=quay-standalone-basic \
   -v $QUAY/config:/conf/stack:Z \
   -v $QUAY/storage:/datastorage:Z \
   registry.redhat.io/quay/quay-rhel8:v3.8.0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter in web UI interface, <strong>create</strong> user <code>registry/redhat12345678</code> and create a new organization <code>cache-quayio</code>, and in the organization settings configure mirror with next values:</p>
<div class="ulist">
<ul>
<li>
<p>Remote Registry: <code>quay.io</code></p>
</li>
<li>
<p>Remote Registry Username, extract from pull-secret:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat ~/pull-secret.json | jq  -r '.auths["quay.io"].auth |select (.!=null)' | base64 -d | awk -F':' '{print $1}'</code></pre>
</div>
</div>
</li>
<li>
<p>Remote Registry Password:</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat ~/pull-secret.json | jq  -r '.auths["quay.io"].auth |select (.!=null)' | base64 -d | awk -F':' '{print $2}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/proxy-cache-config.png" alt="Quay Proxy Cache Config" width="800">
</div>
</div>
</li>
<li>
<p>and Save</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="registryvm-cachecontainer"><a class="anchor" href="#registryvm-cachecontainer"></a>Creating Registry Cache with registry-cache container</h3>
<div class="paragraph">
<p>From Registry VM do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Install dependencies and create dirs</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">yum install -y podman httpd-tools
mkdir -p /data/registry-cache/{auth,data}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>create credentials</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">htpasswd -bBc /data/registry-cache/auth/htpasswd registry redhat12345678</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create pem file</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat /data/registry/certs/registry.crt /data/registry/certs/registry.key  &gt; /data/registry/certs/certs.pem</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>locate pull-secret
<code>/root/pull-secret.json</code></p>
</li>
<li>
<p>Run cache container</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman run -d --name registry-cache \
  -v /root/pull-secret.json:/pull-secret.json:z \
  -v  /data/registry-cache/data:/var/lib/registry:z \
  -e CLEANER_MAXSIZE=10G \
  -e CLEANER_THRESHOLD_PERCENTAGE=20 \
  -e CLEANER_RUNEVERY_TIME=30m \
  -v /data/registry/certs:/certs:z \
  -v /data/registry-cache/auth:/auth:z   \
  -e "REGISTRY_AUTH=htpasswd"  \
  -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -p 6443:8443 \
  quay.io/mvalledi/registry-cache:main</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-registries"><a class="anchor" href="#testing-registries"></a>Testing registries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To be able to test, first of all create credentials and copy it to docker dir (in the registry machine):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Convert it in human-readable json:</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat ~/pull-secret.json | jq  &gt; ~/pull-secret-all.json

vi  ~/pull-secret-all.json</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add credentials in pull-secret-all.json (copy next lines)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">....
....
   "registry.dsal:5000": {
      "email": "registry@redhat.com",
      "auth": "cmVnaXN0cnk6cmVkaGF0MTIzNDU2Nzg="
    },
    "registry.dsal:8443": {
      "email": "registry@redhat.com",
      "auth": "cmVnaXN0cnk6cmVkaGF0MTIzNDU2Nzg="
    },
    "registry.dsal": {
      "email": "registry@redhat.com",
      "auth": "cmVnaXN0cnk6cmVkaGF0MTIzNDU2Nzg="
    },
    "registry.dsal:6443": {
      "email": "registry@redhat.com",
      "auth": "cmVnaXN0cnk6cmVkaGF0MTIzNDU2Nzg="
    }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy it again to <code>.docker</code> dir (and to <code>/tmp</code> directory for a later use )</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cp ~/pull-secret-all.json ~/.docker/config.json
cp ~/pull-secret-all.json /tmp/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will test all registries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registry v2 (push and pull)</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3

podman push quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3 registry.dsal:5000/test

podman rmi registry.dsal:5000/test; podman system prune --all --force; podman rmi --all

podman pull registry.dsal:5000/test</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Registry-mirror (push and pull)</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3

podman push quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3 registry.dsal:8443/test

podman rmi registry.dsal:8443/test; podman system prune --all --force; podman rmi --all

podman pull registry.dsal:8443/test</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Registry Quay standalone with proxy cache. (Add registry.dsal entry in /etc/hosts of the registry VM) (only pull)</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman rmi registry.dsal/cache-quayio/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3; podman system prune --all --force; podman rmi --all

podman pull registry.dsal/cache-quayio/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Registry Cache (only pull)</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman rmi registry.dsal:6443/quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3; podman system prune --all --force; podman rmi --all

podman pull registry.dsal:6443/quay.io/openshift-release-dev/ocp-release@sha256:e86e058f7f66a687e273792f2e4ec70f3cc43ec9d2894bebee5caf5c4d4851a3</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html">OCP Disconnected Workshop</a></span>
  <span class="next"><a href="02-Deploy-Cluster.html">Cluster Deployment</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
